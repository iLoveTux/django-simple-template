{% extends 'base.html' %}
{% load static %}

{% block title %}Subscription{% endblock %}

{% block content %}
<div class="container">
    <h1>Subscriptions</h1>
    {% if subscriptions %}
        <h2>Your Active Subscriptions</h2>
        <ul>
            {% for sub in subscriptions %}
                <li>{{ sub.price.product.name }} - {{ sub.price.unit_amount }} {{ sub.price.currency|upper }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <h2>Available Plans</h2>
    {% for product in products %}
        <div class="product">
            <h3>{{ product.name }}</h3>
            <p>{{ product.description }}</p>
            {% for price in product.prices.all %}
                {% if price.active %}
                    <p>Price: {{ price.unit_amount }} {{ price.currency|upper }} per {{ price.recurring.interval }}</p>
                    <button onclick="createCheckoutSession('{{ price.id }}')">Subscribe</button>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');

function createCheckoutSession(priceId) {
    fetch('/create-checkout-session/' + priceId + '/', {
        method: 'GET',
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            alert(data.error);
        } else {
            return stripe.redirectToCheckout({ sessionId: data.sessionId });
        }
    })
    .then(function(result) {
        if (result && result.error) {
            alert(result.error.message);
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}